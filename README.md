# ReadMe: Класс `Model`

Этот `README` описывает класс `Model`, который является компонентом для обучения, сохранения, загрузки и тестирования моделей классификации изображений тканей человека. Класс `Model` использует предобученную нейронную сеть `AlexNet` из библиотеки `torchvision`.

## Полученные баллы:
Основная часть:

Реализована модель классификации, основанной на свёрточных нейронных сетях(AlexNet) (минимальная точность ACC на предоставленной тестовой выборке – 0.95) - 30 баллов

Дополнения:

Вывод различных показателей в процессе обучения (например, значение функции потерь на каждой эпохе) - 1

Автоматическое сохранение модели при обучении - 1

Любое дополнительное улучшение не из списка, улучшающее результаты классификации или улучшающее опыт взаимодействия с
моделью:

предобработка входных изображений (изменение размера, центральное кадрирование, преобразование в тензор, нормализация ImageNet) - 1

Модель автоматически определяет наличие GPU и использует его для ускорения вычислений (cuda или cpu) - 1

## Назначение класса `Model`

Класс `Model` содержит всю необходимую логику для работы с моделью глубокого обучения:

*   **Инициализация:** Настройка архитектуры модели, функции потерь, оптимизатора и предобработки изображений.
*   **Сохранение/Загрузка:** Механизмы для сохранения и загрузки весов модели, что критически важно для воспроизводимости и дальнейшего использования обученных моделей.
*   **Обучение:** Реализация цикла обучения с поддержкой валидации и сохранения лучшей модели.
*   **Тестирование:** Функции для оценки производительности модели на наборах данных или отдельных изображениях.

## Зависимости

Для работы класса `Model` требуются следующие библиотеки и классы:

*   `torch`, `torch.nn`, `torch.optim`: Основные компоненты PyTorch для построения и обучения нейронных сетей.
*   `torchvision.models`, `torchvision.transforms`: Для использования предобученных моделей (AlexNet) и трансформаций изображений.
*   `gdown`: Для загрузки моделей из Google Drive (используется в `load` при `EVALUATE_ONLY`).
*   `copy`: Для создания глубоких копий состояний модели.
*   `PIL.Image`: Для работы с изображениями (преобразование из `numpy` в `PIL.Image` перед трансформациями).
*   `Dataset` (из этого ноутбука): Для предоставления данных для обучения и тестирования.
*   `HistologyTorchDataset` (из этого ноутбука): Обёртка над `Dataset` для совместимости с `torch.utils.data.DataLoader`.
*   `TISSUE_CLASSES` (константа из этого ноутбука): Определяет количество и названия классов.
*   `EVALUATE_ONLY` (константа из этого ноутбука): Флаг для режима оценки, влияющий на загрузку модели.

## Методы класса `Model`

### `__init__(self, num_classes=None)`

**Назначение:** Конструктор класса. Инициализирует модель и все связанные с ней параметры.

**Параметры:**
*   `num_classes` (int, optional): Количество классов для классификации. Если `None`, используется `len(TISSUE_CLASSES)`.

**Описание:**
1.  Определяет вычислительное устройство (`CPU` или `CUDA/GPU`).
2.  Загружает предобученную модель `AlexNet` (`models.alexnet(weights=models.AlexNet_Weights.DEFAULT)`).
3.  Модифицирует последний полносвязный слой AlexNet (`self.model.classifier[6]`), чтобы его выходное количество признаков соответствовало `num_classes`.
4.  Перемещает модель на выбранное устройство (`self.device`).
5.  Инициализирует функцию потерь (`nn.CrossEntropyLoss`) и оптимизатор (`optim.Adam`).
6.  Определяет последовательность трансформаций (`torchvision.transforms.Compose`) для предобработки входных изображений (изменение размера, центральное кадрирование, преобразование в тензор, нормализация ImageNet).

### `save(self, name: str)`

**Назначение:** Сохраняет текущее состояние модели и оптимизатора.

**Параметры:**
*   `name` (str): Имя, используемое для формирования имени файла сохранения (например, `'best.pth'`).

**Описание:**
1.  Формирует путь для сохранения файла на Google Drive (`/content/drive/MyDrive/{name}.pth`).
2.  Сохраняет словарь, содержащий `model_state_dict` (состояние весов модели) и `optimizer_state_dict` (состояние оптимизатора), используя `torch.save`.

### `load(self, name: str)`

**Назначение:** Загружает ранее сохраненное состояние модели и оптимизатора.

**Параметры:**
*   `name` (str): Имя сохраненного файла.

**Описание:**
1.  Если константа `EVALUATE_ONLY` установлена в `True`, пытается загрузить модель из  Google Drive, используя `gdown`.
2.  В противном случае, загружает модель из локального пути на Google Drive (`/content/drive/MyDrive/{name}.pth`).
3.  Проверяет существование файла. Если файл не найден, выводит ошибку.
4.  Загружает чекпоинт (`checkpoint = torch.load(...)`).
5.  Применяет загруженные состояния к модели (`self.model.load_state_dict(...)`) и оптимизатору (`self.optimizer.load_state_dict(...)`).
6.  Переводит модель в режим оценки (`self.model.eval()`), отключая слои вроде Dropout и Batch Normalization.

### `train(self, train_dataset: Dataset, val_dataset: Dataset = None, epochs=10, batch_size=32)`

**Назначение:** Обучает модель на заданном наборе данных.

**Параметры:**
*   `train_dataset` (Dataset): Объект `Dataset`, содержащий обучающие данные.
*   `val_dataset` (Dataset, optional): Объект `Dataset`, содержащий данные для валидации. Если предоставлен, модель будет валидироваться на каждой эпохе, и будет сохраняться лучшее состояние по валидационным потерям.
*   `epochs` (int): Количество эпох обучения.
*   `batch_size` (int): Размер батча для DataLoader.

**Описание:**
1.  Создает `HistologyTorchDataset` и `DataLoader` для обучающего и валидационного наборов данных.
2.  Итерирует по указанному количеству эпох.
3.  В каждой эпохе:
    *   **Фаза обучения:** Переводит модель в режим `train()`, обнуляет градиенты, выполняет прямой проход, вычисляет потери, выполняет обратное распространение ошибки и шаг оптимизатора. Отслеживает средние потери на обучении.
    *   **Фаза валидации :** Переводит модель в режим `eval()`, отключает вычисление градиентов (`torch.no_grad()`), выполняет прямой проход для валидационных данных, вычисляет потери. Если текущие валидационные потери ниже предыдущих, сохраняет текущее состояние модели как "лучшее".
4.  После завершения обучения, если была найдена лучшая модель по валидации, восстанавливает её состояние.

### `test_on_dataset(self, dataset: Dataset, limit=None)`

**Назначение:** Тестирует модель на полном или частичном наборе данных.

**Параметры:**
*   `dataset` (Dataset): Объект `Dataset`, содержащий тестовые данные.
*   `limit` (float or None, optional): Если `float`, указывает долю (`0.0` до `1.0`) данных для тестирования. Если `None`, тестируется весь набор данных.

**Описание:**
1.  Переводит модель в режим оценки (`self.model.eval()`) и отключает вычисление градиентов.
2.  Собирает предсказания модели и истинные метки.
3.  В зависимости от параметра `limit`:
    *   Если `limit` `None`, использует `DataLoader` для эффективного батчевого тестирования всего набора данных.
    *   Если `limit` задан, итерирует по указанному количеству изображений, загружая их по одному с помощью `dataset.image_with_label`.
4.  Для каждого изображения/батча выполняет прямой проход через модель и получает предсказанный класс.
5.  Возвращает список предсказанных классов.

### `test_on_image(self, img_np: np.ndarray)`

**Назначение:** Предсказывает класс для одного входного изображения.

**Параметры:**
*   `img_np` (np.ndarray): Изображение в формате NumPy массива (H, W, C).

**Описание:**
1.  Переводит модель в режим оценки (`self.model.eval()`) и отключает вычисление градиентов.
2.  Преобразует входной NumPy массив в `PIL.Image`, затем применяет те же трансформации, что и при обучении, добавляет размерность батча (`unsqueeze(0)`) и перемещает на устройство.
3.  Выполняет прямой проход через модель (`self.model(img_tensor)`) и получает предсказанный класс (`torch.max(...).item()`).
4.  Возвращает предсказанный класс (целое число).
